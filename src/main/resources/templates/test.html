<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTube Cursor Mode Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .container {
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
        }

        .status {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .status-label {
            color: #888;
        }

        .status-value {
            color: #4CAF50;
            font-weight: bold;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background: #ff0000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }

        button:hover {
            background: #cc0000;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .test-area {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .test-button {
            background: #333;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-button:hover {
            background: #444;
            transform: scale(1.05);
        }

        .test-button.clicked {
            background: #4CAF50;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #virtualCursor {
            position: fixed;
            width: 30px;
            height: 30px;
            background: red;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }

        #webcam {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            border: 3px solid #ff0000;
            border-radius: 12px;
            transform: scaleX(-1);
        }


        .log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        .log-entry {
            margin: 3px 0;
            color: #0f0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ðŸŽ¬ WeTube Cursor Mode Test</h1>

    <div class="status">
        <div class="status-item">
            <span class="status-label">Status:</span>
            <span class="status-value" id="modeStatus">Gestoppt</span>
        </div>
        <div class="status-item">
            <span class="status-label">Cursor:</span>
            <span class="status-value" id="cursorState">Inaktiv</span>
        </div>
        <div class="status-item">
            <span class="status-label">Cursor Position:</span>
            <span class="status-value" id="cursorPos">-</span>
        </div>
    </div>


    <div class="controls">
        <button id="startBtn">Cursor Mode Starten</button>
        <button id="stopBtn" disabled>Cursor Mode Stoppen</button>
    </div>

    <div class="test-area">
        <div class="test-button" data-id="1">
            <h3>Button 1</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
        <div class="test-button" data-id="2">
            <h3>Button 2</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
        <div class="test-button" data-id="3">
            <h3>Button 3</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
        <div class="test-button" data-id="4">
            <h3>Button 4</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
        <div class="test-button" data-id="5">
            <h3>Button 5</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
        <div class="test-button" data-id="6">
            <h3>Button 6</h3>
            <p>Klicke mich mit Pinch!</p>
        </div>
    </div>
</div>

<div id="virtualCursor" style="display: none;"></div>
<div class="log" id="logContainer"></div>
<video id="webcam" autoplay playsinline></video>
<canvas id="output" style="display: none;"></canvas>

<!-- MediaPipe Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<script>class CursorModeController {
    constructor() {
        this.isActive = false;
        this.cursor = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        this.isPinching = false;
        this.fistStart = null;

        this.callbacks = {
            onCursorMove: null,
            onCursorClick: null,
            onModeExit: null
        };

        this.SMOOTHING = 0.3;
        this.PINCH_ON = 0.045;
        this.PINCH_OFF = 0.07;
        this.FIST_DISTANCE = 0.11;
        this.FIST_HOLD_MS = 500;
    }

    async initialize(video) {
        this.hands = new Hands({
            locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
        });

        this.hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        this.hands.onResults(r => this.onResults(r));

        this.camera = new Camera(video, {
            onFrame: async () => {
                if (this.isActive) await this.hands.send({ image: video });
            },
            width: 1280,
            height: 720
        });
    }

    async start() {
        this.isActive = true;
        await this.camera.start();
    }

    stop() {
        this.isActive = false;
        this.camera.stop();
    }

    on(event, cb) {
        this.callbacks[event] = cb;
    }

    onResults(results) {
        if (!results.multiHandLandmarks?.length) return;
        const lm = results.multiHandLandmarks[0];

        this.updateCursor(lm);
        this.detectPinch(lm);
        this.detectExit(lm);
    }

    updateCursor(lm) {
        const index = lm[8];
        const tx = (1 - index.x) * window.innerWidth;
        const ty = index.y * window.innerHeight;

        this.cursor.x += (tx - this.cursor.x) * this.SMOOTHING;
        this.cursor.y += (ty - this.cursor.y) * this.SMOOTHING;

        this.callbacks.onCursorMove?.(this.cursor.x, this.cursor.y);
    }

    detectPinch(lm) {
        const d = this.dist(lm[4], lm[8]);

        if (!this.isPinching && d < this.PINCH_ON) {
            this.isPinching = true;
            this.callbacks.onCursorClick?.(this.cursor.x, this.cursor.y);
        }

        if (this.isPinching && d > this.PINCH_OFF) {
            this.isPinching = false;
        }
    }

    detectExit(lm) {
        const wrist = lm[0];
        const index = lm[8];
        const middle = lm[12];

        const fist =
            this.dist(wrist, index) < this.FIST_DISTANCE &&
            this.dist(wrist, middle) < this.FIST_DISTANCE;

        if (fist) {
            if (!this.fistStart) this.fistStart = performance.now();
            else if (performance.now() - this.fistStart > this.FIST_HOLD_MS) {
                this.callbacks.onModeExit?.();
                this.fistStart = null;
            }
        } else {
            this.fistStart = null;
        }
    }

    dist(a, b) {
        return Math.hypot(a.x - b.x, a.y - b.y, a.z - b.z);
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    const video = document.getElementById("webcam");
    const cursor = document.getElementById("virtualCursor");
    const cursorPos = document.getElementById("cursorPos");
    const cursorState = document.getElementById("cursorState");
    const modeStatus = document.getElementById("modeStatus");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const controller = new CursorModeController();
    await controller.initialize(video);

    controller.on("onCursorMove", (x, y) => {
        cursor.style.left = x + "px";
        cursor.style.top = y + "px";
        cursorPos.textContent = `(${Math.round(x)}, ${Math.round(y)})`;
        cursorState.textContent = "Aktiv";
    });

    controller.on("onCursorClick", (x, y) => {
        cursorState.textContent = "Klick ðŸ¤";
        const el = document.elementFromPoint(x, y);
        el?.closest(".test-button")?.classList.add("clicked");
        setTimeout(() => cursorState.textContent = "Aktiv", 300);
    });

    controller.on("onModeExit", () => {
        controller.stop();
        cursor.style.display = "none";
        cursorState.textContent = "Inaktiv";
        modeStatus.textContent = "Gestoppt";
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    startBtn.onclick = async () => {
        await controller.start();
        cursor.style.display = "block";
        modeStatus.textContent = "Aktiv";
        startBtn.disabled = true;
        stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
        controller.stop();
        cursor.style.display = "none";
        cursorState.textContent = "Inaktiv";
        modeStatus.textContent = "Gestoppt";
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };
});
</script>
</body>
</html>